@section Styles{
    <style>
        .new {
            margin-left: 10px;
        }
        /*搜尋input*/
        #searchText {
            margin-left: auto;
            margin-right: 0px;
            text-align: center;
            width: 15%;
        }

        /*新增訂位訊息的modal*/
        .modal-content {
            background-color: #191C24
        }

        #create_container input, #create_container select {
            background: rgb(133, 133, 133);
            border-radius: 5px;
        }

        .modal-footer button {
            background-color: #6c757d;
            border-radius: 5px;
        }

        .modal select, .modal input {
            color: black;
        }

        textarea {
            resize: none; /*不讓使用者调整 <textarea> 元素的大小*/
            overflow: auto; /*需要時顯示滾輪條  */
            height: 20px;
            background-color: rgb(133, 133, 133);
        }

        .nono {
            color: red;
        }
    </style>
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vue2-datepicker@3.11.0/index.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.all.min.js"></script>

<!-- Table Start -->
<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="bg-secondary rounded h-100 p-4" id="app">
            <h6 class="mb-4">訂單管理系統</h6>
            <div class="col-12 row">
                <input type="text" class="form-control col-md-4" v-model="searchText" id="searchText" placeholder="請輸入搜尋關鍵字" @@keyup="filterOrder" />
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr class="text-center">
                            <th scope="col">訂單編號</th>
                            <th scope="col">會員編號</th>
                            <th scope="col">消費日期</th>
                            <th scope="col">人數</th>
                            <th scope="col">內用/外帶</th>
                            <th scope="col">桌號</th>
                            <th scope="col">消費總額</th>
                            <th scope="col">是否結帳</th>
                            <th scope="col">會員折扣</th>
                            <th scope="col">最終金額</th>
                            <th scope="col">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="text-center" v-for="order in orderInfo">
                            <template>
                                <td scope="row">{{order.orderId}}</td>
                                <td>{{order.memberId}}</td>
                                <td>{{order.orderDate}}</td>
                                <td>{{order.customerCount}}</td>
                                <td v-if="order.isTakeway">外帶</td>
                                <td v-else>內用</td>
                                <td>{{order.tableId}}</td>
                                <td>{{order.totalPrice}}</td>
                                <td v-if="order.isSuccess">已結帳</td>
                                <td v-else>未結帳</td>
                                <td>{{order.levelDiscount}}</td>
                                <td>{{order.finalPrice}}</td>
                                <td>
                                    <button type="button" class="btn btn-light btn-sm" v-if="order.isSuccess==false" @@click="check">
                                        結帳
                                    </button>
                                    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#editModal" @@click="getOrderDetail(order.orderId)">
                                        展開明細
                                    </button>
                                </td>
                            </template>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Table End -->
            <!--Edit Modal-->
            <div class="modal fade bookingdModal" id="editModal" data-bs-backdrop="static"
                 data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" id="staticBackdropLabel">訂單明細</h3>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="bookinginfo">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th scope="col">訂單明細編號</th>
                                            <th scope="col">產品名稱</th>
                                            <th scope="col">數量</th>
                                            <th scope="col">單價</th>
                                            <th scope="col">會員折扣</th>
                                            <th scope="col">小計金額</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="order in orderDetailInfo">
                                            <td>{{order.orderDetailId}}</td>
                                            <td>{{order.productName}}</td>
                                            <td>{{order.quantity}}</td>
                                            <td>{{order.unitPrice}}</td>
                                            <td>{{order.discount}}</td>
                                            <td>{{order.subtotalPrice}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <form id="booking">
                            <p class="checkMessage"></p>
                            <div class="modal-footer">
                                <div class="row m-0">
                                    <button class="col btneditproducts m-1 btnCheckinModal" type="button" data-bs-dismiss="modal"><i class="fa-solid fa-square-check"></i> 關閉</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="~/vue/vue.min.js"></script>
    <script src="/axios/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue2-datepicker@3.11.0/index.js"></script>

    <script>
        let app = new Vue({
            el: '#app',
            data: {
                orderInfo: [],
                originalInfo: [],
                orderDetailInfo:[],
                searchText: '',
                original: {
                    orderId: '',
                    memberId: '',
                    orderDate: null,
                    customerCount: "",
                    isTakeway: '',
                    totalPrice: "",
                    levelDiscount: "",
                    finalPrice:"",
                },
                regis: false,
            },

            methods: {
                //篩選order
                filterOrder: function () {
                    let _this = this;
                    var orderlist = [];
                    if (_this.searchText === "") {
                        _this.getOrder();
                    } else {
                        for (var i = 0; i < _this.originalInfo.length; i++) {
                            var item = _this.originalInfo[i];
                            var orderId = item.orderId;
                            var memberId = item.memberId;
                            var orderDate = item.orderDate.toString();
                            var customerCount = item.customerCount;
                            var isTakeway = item.isTakeway;
                            var totalPrice = item.totalPrice;
                            var levelDiscount = item.levelDiscount;
                            var finalPrice = item.finalPrice;

                            var regex = new RegExp(_this.searchText, 'i');

                            if (
                                regex.test(orderId) ||
                                regex.test(memberId) ||
                                regex.test(orderDate) ||
                                regex.test(customerCount) ||
                                regex.test(isTakeway) ||
                                regex.test(totalPrice) ||
                                regex.test(levelDiscount) ||
                                regex.test(finalPrice)
                            ) {
                                orderlist.push(item);
                            }
                        }
                    }

                    _this.orderInfo = orderlist;
                },
                //結帳
                check:function(){

                },
                //取得訂單明細
                getOrderDetail:function(orderId){
                    let _this = this;
                    axios.get(`/api/OrderBackend/GetOrderDetail/${orderId}`).then(response => {
                        _this.orderDetailInfo=response.data
                    })
                },
                //抓訂單資料
                getOrder: function () {
                    let _this = this;
                    axios.get("/api/OrderBackend/GetOrder").then(
                        response => {
                            _this.orderInfo = response.data;
                            _this.originalInfo = response.data;
                        }
                    );
                },              
            },
            mounted: function () {
                let _this = this;
                _this.getOrder();
            }
        });
    </script>
}
